<% content_for :title, "Estudiantes" %>

<h1 style="font-size: 28px; font-weight: bold; margin-bottom: 20px;">Listado de Estudiantes</h1>

<!-- FILTROS -->
<div style="background: #f9fafb; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 20px;">
  <%= form_with url: estudiantes_path, method: :get, local: true do %>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; align-items: end;">
      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Curso/Grado</label>
        <select name="curso" style="width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px 12px; font-size: 14px;">
          <option value="">Todos</option>
          <% @cursos.each do |c| %>
            <option value="<%= c %>" <%= "selected" if params[:curso].to_s == c.to_s %>><%= c %></option>
          <% end %>
        </select>
      </div>
      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Taller</label>
        <select name="taller_id" style="width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px 12px; font-size: 14px;">
          <option value="">Todos</option>
          <% @talleres.each do |t| %>
            <option value="<%= t.id %>" <%= "selected" if params[:taller_id].to_s == t.id.to_s %>><%= t.nombre %></option>
          <% end %>
        </select>
      </div>
      <div style="display: flex; gap: 8px;">
        <button type="submit" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üîç Filtrar</button>
        <%= link_to "Limpiar", estudiantes_path, style: "padding: 8px 16px; background: #e5e7eb; color: #4b5563; border-radius: 6px; text-decoration: none; font-weight: 500; display: inline-block;" %>
      </div>
    </div>
  <% end %>
</div>

<!-- BOTONES DE ACCI√ìN -->
<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
  <% if user_signed_in? %>
    <%= link_to "üë§ Ingresar Estudiante", new_estudiante_path,
        style: "padding: 10px 16px; background: #2563eb; color: white; border-radius: 6px; text-decoration: none; font-weight: 500;" %>
    <%= link_to "üë• Ingresar 10 Estudiantes", bulk_new_estudiantes_path,
      style: "padding: 10px 16px; background: #6366f1; color: white; border-radius: 6px; text-decoration: none; font-weight: 500;" %>
  <% else %>
    <%= link_to "üîê Inicia sesi√≥n para ingresar estudiantes", new_user_session_path,
        style: "padding: 10px 16px; background: #e5e7eb; color: #4b5563; border-radius: 6px; text-decoration: none; font-weight: 500; border: 1px solid #d1d5db;" %>
  <% end %>
</div>

<!-- DATOS -->
<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
  <% if @estudiantes.any? %>
    
    <!-- VERSION DESKTOP (TABLA) -->
    <div style="display: none; overflow-x: auto;" class="desktop-view">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
            <th style="padding: 12px; text-align: left; font-weight: 600;">Nombre</th>
            <th style="padding: 12px; text-align: left; font-weight: 600;">Curso</th>
            <th style="padding: 12px; text-align: left; font-weight: 600;">Taller</th>
            <th style="padding: 12px; text-align: left; font-weight: 600;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% @estudiantes.each do |e| %>
            <% 
              # Obtener talleres donde tiene calificaciones (talleres activos)
              # Cargar calificaciones solo cuando sea necesario
              talleres_con_calificaciones = Calificacion.where(estudiante_id: e.id).distinct.map(&:taller)
              # Si no hay calificaciones, usar el taller_id principal
              talleres_mostrar = talleres_con_calificaciones.any? ? talleres_con_calificaciones : (e.taller ? [e.taller] : [])
              talleres_faltantes = e.max_talleres_por_periodo - talleres_mostrar.count
            %>
            <tr style="border-bottom: 1px solid #e5e7eb;">
              <td style="padding: 12px;"><strong><%= e.nombre %></strong></td>
              <td style="padding: 12px;"><%= e.curso %></td>
              <td style="padding: 12px;">
                <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                  <% if talleres_mostrar.any? %>
                    <% talleres_mostrar.each do |taller| %>
                      <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 13px; font-weight: 500;">
                        <%= taller.nombre %>
                      </span>
                    <% end %>
                  <% else %>
                    <span style="color: #d1d5db;">Sin taller</span>
                  <% end %>
                  
                  <% if talleres_faltantes > 0 %>
                    <span style="background: #fef2f2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; border: 1px solid #fecaca;">
                      Faltan <%= talleres_faltantes %> <%= talleres_faltantes == 1 ? 'taller' : 'talleres' %>
                    </span>
                  <% elsif talleres_faltantes == 0 && talleres_mostrar.any? %>
                    <span style="background: #f0fdf4; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; border: 1px solid #bbf7d0;">
                      ‚úì Completo
                    </span>
                  <% end %>
                </div>
              </td>
              <td style="padding: 12px; white-space: nowrap;">
                <%= link_to "üëÅÔ∏è Ver", estudiante_path(e.id), style: "margin-right: 10px; color: #2563eb; text-decoration: none;" %>
                <% if user_signed_in? && current_user.admin? %>
                  <%= link_to "‚úèÔ∏è Editar", edit_estudiante_path(e.id), style: "margin-right: 10px; color: #f59e0b; text-decoration: none;" %>
                  <%= link_to "üóëÔ∏è Eliminar", estudiante_path(e.id), method: :delete,
                        data: { confirm: "¬øSeguro?" }, style: "color: #dc2626; text-decoration: none;" %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- VERSION MOBILE (CARDS) -->
    <div style="display: block;">
      <% @estudiantes.each do |e| %>
        <% 
          # Obtener talleres donde tiene calificaciones (talleres activos)
          # Cargar calificaciones solo cuando sea necesario
          talleres_con_calificaciones = Calificacion.where(estudiante_id: e.id).distinct.map(&:taller)
          # Si no hay calificaciones, usar el taller_id principal
          talleres_mostrar = talleres_con_calificaciones.any? ? talleres_con_calificaciones : (e.taller ? [e.taller] : [])
          talleres_faltantes = e.max_talleres_por_periodo - talleres_mostrar.count
        %>
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
          <div style="margin-bottom: 12px;">
            <h2 style="font-size: 16px; font-weight: 600; color: #1f2937; margin: 0;"><%= e.nombre %></h2>
          </div>
          
          <div style="background: #f9fafb; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
            <p style="margin: 6px 0; font-size: 14px;"><span style="color: #9ca3af; font-weight: 500;">Curso:</span> <span style="color: #1f2937; font-weight: 600;"><%= e.curso %></span></p>
            <p style="margin: 6px 0; font-size: 14px;"><span style="color: #9ca3af; font-weight: 500;">Talleres:</span></p>
            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;">
              <% if talleres_mostrar.any? %>
                <% talleres_mostrar.each do |taller| %>
                  <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                    <%= taller.nombre %>
                  </span>
                <% end %>
              <% else %>
                <span style="color: #d1d5db; font-size: 13px;">Sin taller</span>
              <% end %>
              
              <% if talleres_faltantes > 0 %>
                <span style="background: #fef2f2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; border: 1px solid #fecaca;">
                  Faltan <%= talleres_faltantes %>
                </span>
              <% elsif talleres_faltantes == 0 && talleres_mostrar.any? %>
                <span style="background: #f0fdf4; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; border: 1px solid #bbf7d0;">
                  ‚úì Completo
                </span>
              <% end %>
            </div>
          </div>
          
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <%= link_to "üëÅÔ∏è Ver", estudiante_path(e.id), style: "padding: 8px 12px; background: #2563eb; color: white; border-radius: 4px; text-decoration: none; font-size: 14px; flex-grow: 1; text-align: center;" %>
            <% if user_signed_in? && current_user.admin? %>
              <%= link_to "‚úèÔ∏è Editar", edit_estudiante_path(e.id), style: "padding: 8px 12px; background: #f59e0b; color: white; border-radius: 4px; text-decoration: none; font-size: 14px; flex-grow: 1; text-align: center;" %>
              <%= link_to "üóëÔ∏è Eliminar", estudiante_path(e.id), method: :delete,
                    data: { confirm: "¬øSeguro?" }, style: "padding: 8px 12px; background: #dc2626; color: white; border-radius: 4px; text-decoration: none; font-size: 14px; flex-grow: 1; text-align: center;" %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <style>
      @media (min-width: 768px) {
        .desktop-view { display: block !important; }
        div[style*="display: block"]:last-of-type { display: none !important; }
      }
    </style>
  <% else %>
    <p style="text-align: center; color: #6b7280; padding: 20px;">No hay estudiantes registrados. <%= link_to "Crear uno", new_estudiante_path, style: "color: #2563eb; text-decoration: underline;" %></p>
  <% end %>
</div>
