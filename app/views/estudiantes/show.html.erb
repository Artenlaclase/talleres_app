<% if notice.present? %>
  <div style="background: #d1fae5; border: 1px solid #6ee7b7; border-radius: 8px; padding: 12px; margin-bottom: 16px; color: #065f46;">
    <%= notice %>
  </div>
<% end %>

<!-- HEADER DEL ESTUDIANTE -->
<div style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
  <h1 style="font-size: 32px; font-weight: bold; margin-bottom: 16px;"><%= @estudiante.nombre %></h1>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
    <div>
      <p style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Curso</p>
      <p style="font-size: 18px; font-weight: 600;"><%= @estudiante.curso %></p>
    </div>
    <div>
      <p style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Talleres Inscritos</p>
      <p style="font-size: 18px; font-weight: 600; color: #2563eb;"><%= @talleres_inscritos.count %> / <%= @estudiante.max_talleres_por_periodo %></p>
    </div>
    <div>
      <p style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Estado</p>
      <p style="font-size: 18px; font-weight: 600; <% if @talleres_faltantes == 0 then %>color: #16a34a;<% else %>color: #f59e0b;<% end %>">
        <% if @talleres_faltantes == 0 %>
          âœ“ Completo
        <% else %>
          Faltan <%= @talleres_faltantes %> <%= 'taller' if @talleres_faltantes == 1 %><%= 'talleres' if @talleres_faltantes != 1 %>
        <% end %>
      </p>
    </div>
  </div>

  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
    <% if user_signed_in? && current_user.admin? %>
      <%= link_to "âœï¸ Editar", edit_estudiante_path(@estudiante),
            style: "padding: 8px 16px; background: #f59e0b; color: white; border-radius: 6px; text-decoration: none; font-weight: 500;" %>
      <%= button_to "ðŸ—‘ï¸ Eliminar", @estudiante, method: :delete, data: { confirm: "Â¿Eliminar?" },
            style: "padding: 8px 16px; background: #dc2626; color: white; border-radius: 6px; font-weight: 500; border: none; cursor: pointer;" %>
      <%= link_to "âž• Otro Estudiante", new_estudiante_path,
        style: "padding: 8px 16px; background: #3b82f6; color: white; border-radius: 6px; text-decoration: none; font-weight: 500;" %>
    <% end %>
    <%= link_to "â† Volver", estudiantes_path,
          style: "padding: 8px 16px; background: #6b7280; color: white; border-radius: 6px; text-decoration: none; font-weight: 500;" %>
  </div>
</div>

<!-- TALLERES INSCRITOS -->
<div style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
  <h2 style="font-size: 22px; font-weight: bold; margin-bottom: 16px;">ðŸ“š Talleres Inscritos</h2>
  
  <% if @talleres_inscritos.any? %>
    <div style="display: grid; gap: 12px;">
      <% @talleres_inscritos.each do |taller| %>
        <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; background: #f9fafb;">
          <!-- HEADER DEL TALLER -->
          <div style="margin-bottom: 12px;">
            <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #1f2937;">
              <%= link_to taller.nombre, taller_path(taller), style: "color: #2563eb; text-decoration: none;" %>
            </h3>
            <p style="color: #6b7280; margin-bottom: 8px; line-height: 1.5;"><%= taller.descripcion %></p>
            <div style="display: flex; gap: 12px; font-size: 14px; color: #6b7280;">
              <span>ðŸ“… <%= taller.fecha %></span>
              <span>ðŸ‘¥ <%= taller.cupos %> cupos</span>
            </div>
          </div>
          
          <!-- CALIFICACIONES HORIZONTALES -->
          <% calificaciones = @calificaciones_por_taller[taller.id] || [] %>
          <% if calificaciones.any? %>
            <div style="background: #f3f4f6; border-radius: 6px; padding: 12px; margin-top: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <p style="font-size: 12px; color: #6b7280; font-weight: 600;">CALIFICACIONES (<%= calificaciones.count %>)</p>
                <p style="font-size: 12px; color: #9ca3af; font-style: italic;">
                  <% calificaciones_faltantes = (taller.numero_evaluaciones || 5) - calificaciones.count %>
                  <% if calificaciones_faltantes > 0 %>
                    Faltan <%= calificaciones_faltantes %> <%= calificaciones_faltantes == 1 ? 'calificaciÃ³n' : 'calificaciones' %>
                  <% else %>
                    âœ“ Completo
                  <% end %>
                </p>
              </div>
              
              <!-- GRID HORIZONTAL DE NOTAS + PROMEDIO EN MISMA LÃNEA -->
              <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: end;">
                <!-- NOTAS -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                  <% calificaciones.each do |cal| %>
                    <div style="background: white; border-radius: 4px; padding: 10px; border-left: 4px solid <%= if cal.nota >= 5.5 then '#16a34a' elsif cal.nota >= 4.0 then '#f59e0b' else '#dc2626' end %>;">
                      <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px; word-break: break-word;"><%= truncate(cal.nombre_evaluacion, length: 20) %></div>
                      <div style="font-size: 18px; font-weight: bold; <%= if cal.nota >= 5.5 then 'color: #16a34a;' elsif cal.nota >= 4.0 then 'color: #f59e0b;' else 'color: #dc2626;' end %>">
                        <%= number_with_precision(cal.nota, precision: 1) %>
                      </div>
                      <div style="font-size: 10px; color: #9ca3af; margin-top: 4px;"><%= truncate(cal.tema, length: 15) %></div>
                    </div>
                  <% end %>
                </div>
                
                <!-- PROMEDIO DEL TALLER -->
                <% promedio = (calificaciones.sum(&:nota) / calificaciones.count).round(1) %>
                <div style="background: #eff6ff; border-radius: 4px; padding: 12px; min-width: 110px; text-align: center; border: 1px solid #bfdbfe;">
                  <p style="font-size: 10px; color: #0c4a6e; font-weight: 600; margin-bottom: 4px;">PROMEDIO</p>
                  <p style="font-size: 24px; font-weight: bold; <%= if promedio >= 5.5 then 'color: #16a34a;' elsif promedio >= 4.0 then 'color: #f59e0b;' else 'color: #dc2626;' end %>">
                    <%= number_with_precision(promedio, precision: 1) %>
                  </p>
                </div>
              </div>
              
              <!-- TEMAS EVALUADOS -->
              <% temas = calificaciones.map(&:tema).uniq.compact %>
              <% if temas.any? %>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                  <p style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 8px;">ðŸ“‹ Temas Evaluados:</p>
                  <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                    <% temas.each do |tema| %>
                      <span style="background: white; border: 1px solid #d1d5db; border-radius: 4px; padding: 4px 8px; font-size: 12px; color: #4b5563;">
                        <%= tema %>
                      </span>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div style="background: #f3f4f6; border-radius: 6px; padding: 12px; margin-top: 12px; color: #9ca3af; text-align: center; font-size: 13px; font-style: italic;">
              Sin calificaciones
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <p style="color: #9ca3af; padding: 16px; text-align: center;">No hay talleres inscritos aÃºn.</p>
  <% end %>
</div>

<!-- TALLERES DISPONIBLES PARA INSCRIBIRSE -->
<% if @talleres_faltantes > 0 && @talleres_disponibles.any? %>
  <div style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <h2 style="font-size: 22px; font-weight: bold; margin-bottom: 16px;">ðŸŽ¯ Talleres Disponibles para Inscribirse (<%= @talleres_disponibles.count %>)</h2>
    
    <div style="display: grid; gap: 12px;">
      <% @talleres_disponibles.each do |taller| %>
        <div style="border: 1px solid #d1d5db; border-radius: 8px; padding: 16px; background: #fafbfc; display: flex; justify-content: space-between; align-items: center;">
          <div style="flex: 1;">
            <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 4px;"><%= taller.nombre %></h3>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 8px;"><%= truncate(taller.descripcion, length: 100) %></p>
            <div style="font-size: 13px; color: #6b7280;">
              <span>ðŸ‘¥ <%= taller.cupos_restantes %>/<%= taller.cupos %> cupos disponibles</span>
            </div>
          </div>
          <% if user_signed_in? && current_user.admin? %>
            <%= link_to "âž• Inscribir", new_taller_inscripcione_path(taller),
                  style: "padding: 8px 16px; background: #10b981; color: white; border-radius: 6px; font-weight: 600; text-decoration: none; margin-left: 12px; display: inline-block;" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
