<% content_for :title, "Calificaciones - Dashboard" %>

<div style="padding: 20px;">
  <h1 style="font-size: 28px; font-weight: bold; margin-bottom: 24px;">ğŸ“Š Dashboard de Calificaciones</h1>

  <!-- FILTROS -->
  <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;">
    <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 16px;">ğŸ” Filtros</h2>
    <%= form_with method: :get, local: true, style: "display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;" do |f| %>
      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Taller</label>
        <%= f.select :taller_id, 
            options_from_collection_for_select(Taller.all, :id, :nombre, params[:taller_id]),
            { prompt: "Todos los talleres" },
            style: "width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px 12px;" %>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Estudiante</label>
        <%= f.select :estudiante_id, 
            options_from_collection_for_select(Estudiante.all, :id, :nombre, params[:estudiante_id]),
            { prompt: "Todos los estudiantes" },
            style: "width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px 12px;" %>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Tema/EvaluaciÃ³n</label>
        <%= f.text_field :tema, placeholder: "Buscar tema...", value: params[:tema],
            style: "width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px 12px;" %>
      </div>

      <div style="display: flex; align-items: flex-end; gap: 8px;">
        <%= f.submit "ğŸ” Filtrar", style: "padding: 10px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;" %>
        <%= link_to "âœ• Limpiar", calificaciones_path, style: "padding: 10px 16px; background: #e5e7eb; color: #4b5563; border-radius: 6px; text-decoration: none; font-weight: 500;" %>
      </div>
    <% end %>
  </div>

  <!-- ESTADÃSTICAS GENERALES -->
  <% 
    calificaciones_filtradas = Calificacion.all
    calificaciones_filtradas = calificaciones_filtradas.where(taller_id: params[:taller_id]) if params[:taller_id].present?
    calificaciones_filtradas = calificaciones_filtradas.where(estudiante_id: params[:estudiante_id]) if params[:estudiante_id].present?
    calificaciones_filtradas = calificaciones_filtradas.where("tema LIKE ?", "%#{params[:tema]}%") if params[:tema].present?
    
    promedio_general = calificaciones_filtradas.any? ? (calificaciones_filtradas.sum(&:nota) / calificaciones_filtradas.count).round(1) : 0
    max_nota = calificaciones_filtradas.any? ? calificaciones_filtradas.max_by(&:nota).nota : 0
    min_nota = calificaciones_filtradas.any? ? calificaciones_filtradas.min_by(&:nota).nota : 0
  %>

  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
    <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px;">
      <p style="margin: 0; color: #1e40af; font-size: 14px; font-weight: 500;">Total de Calificaciones</p>
      <p style="margin: 8px 0 0 0; font-size: 28px; font-weight: bold; color: #1e40af;"><%= calificaciones_filtradas.count %></p>
    </div>

    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 16px;">
      <p style="margin: 0; color: #166534; font-size: 14px; font-weight: 500;">Promedio General</p>
      <p style="margin: 8px 0 0 0; font-size: 28px; font-weight: bold; color: #166534;"><%= number_with_precision(promedio_general, precision: 1) %>/7.0</p>
    </div>

    <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 16px;">
      <p style="margin: 0; color: #92400e; font-size: 14px; font-weight: 500;">Nota MÃ¡xima</p>
      <p style="margin: 8px 0 0 0; font-size: 28px; font-weight: bold; color: #92400e;"><%= number_with_precision(max_nota, precision: 1) %>/7.0</p>
    </div>

    <div style="background: #fee2e2; border: 1px solid #fca5a5; border-radius: 8px; padding: 16px;">
      <p style="margin: 0; color: #7f1d1d; font-size: 14px; font-weight: 500;">Nota MÃ­nima</p>
      <p style="margin: 8px 0 0 0; font-size: 28px; font-weight: bold; color: #7f1d1d;"><%= number_with_precision(min_nota, precision: 1) %>/7.0</p>
    </div>
  </div>

  </div>

  <!-- ESTADÃSTICAS POR TALLER -->
  <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;">
    <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 16px;">ğŸ“ˆ EstadÃ­sticas por Taller</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
      <% Taller.all.each do |taller| %>
        <% cals = calificaciones_filtradas.where(taller_id: taller.id) %>
        <% if cals.any? %>
          <% promedio_taller = (cals.sum(&:nota) / cals.count).round(1) %>
          <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background: #f9fafb;">
            <p style="margin: 0 0 8px 0; color: #1f2937; font-weight: 600; font-size: 16px;"><%= taller.nombre %></p>
            <p style="margin: 0 4px 0 0; color: #6b7280; font-size: 14px;">
              ğŸ“Š Promedio: <strong style="<%= if promedio_taller >= 5.5 then 'color: #16a34a;' elsif promedio_taller >= 4.0 then 'color: #f59e0b;' else 'color: #dc2626;' end %>"><%= number_with_precision(promedio_taller, precision: 1) %>/7.0</strong>
            </p>
            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 14px;">
              ğŸ‘¥ Estudiantes: <strong><%= cals.distinct.count(:estudiante_id) %></strong>
            </p>
            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 14px;">
              ğŸ“ Calificaciones: <strong><%= cals.count %></strong>
            </p>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- ESTADÃSTICAS POR TEMA/EVALUACIÃ“N -->
  <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 16px;">ğŸ¯ Rendimiento por Tema</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
      <% calificaciones_filtradas.group_by(&:tema).each do |tema, cals| %>
        <% next if tema.blank? %>
        <% promedio_tema = (cals.sum(&:nota) / cals.count).round(1) %>
        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background: #f9fafb;">
          <p style="margin: 0 0 8px 0; color: #1f2937; font-weight: 600; font-size: 16px;"><%= tema %></p>
          <p style="margin: 0 4px 0 0; color: #6b7280; font-size: 14px;">
            ğŸ“Š Promedio: <strong style="<%= if promedio_tema >= 5.5 then 'color: #16a34a;' elsif promedio_tema >= 4.0 then 'color: #f59e0b;' else 'color: #dc2626;' end %>"><%= number_with_precision(promedio_tema, precision: 1) %>/7.0</strong>
          </p>
          <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 14px;">
            ğŸ“ Evaluaciones: <strong><%= cals.count %></strong>
          </p>
        </div>
      <% end %>
    </div>
  </div>

</div>
