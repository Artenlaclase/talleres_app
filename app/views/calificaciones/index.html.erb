<% content_for :title, "Calificaciones" %>

<h1 style="font-size: 28px; font-weight: bold; margin-bottom: 20px;">üìä Calificaciones por Estudiante y Taller</h1>

<!-- FILTROS -->
<div style="background: #f9fafb; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 20px;">
  <%= form_with url: calificaciones_path, method: :get, local: true do %>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; align-items: end;">
      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Estudiante</label>
        <select name="estudiante_id" style="width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px 12px; font-size: 14px;">
          <option value="">Todos</option>
          <% @estudiantes.each do |e| %>
            <option value="<%= e.id %>" <%= "selected" if params[:estudiante_id].to_s == e.id.to_s %>><%= e.nombre %></option>
          <% end %>
        </select>
      </div>
      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Taller</label>
        <select name="taller_id" style="width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px 12px; font-size: 14px;">
          <option value="">Todos</option>
          <% @talleres.each do |t| %>
            <option value="<%= t.id %>" <%= "selected" if params[:taller_id].to_s == t.id.to_s %>><%= t.nombre %></option>
          <% end %>
        </select>
      </div>
      <div style="display: flex; gap: 8px;">
        <button type="submit" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üîç Filtrar</button>
        <%= link_to "Limpiar", calificaciones_path, style: "padding: 8px 16px; background: #e5e7eb; color: #4b5563; border-radius: 6px; text-decoration: none; font-weight: 500; display: inline-block;" %>
      </div>
    </div>
  <% end %>
</div>

<!-- BOTONES DE ACCI√ìN -->
<div style="margin-bottom: 20px;">
  <%= link_to "‚ûï Nueva Calificaci√≥n", new_calificacione_path,
      style: "padding: 10px 16px; background: #2563eb; color: white; border-radius: 6px; text-decoration: none; font-weight: 500; display: inline-block;" %>
</div>

<!-- PROMEDIOS POR TALLER -->
<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;">
  <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 16px;">üìà Promedio de Calificaciones por Taller</h2>
  
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
    <% @talleres.each do |t| %>
      <% if @promedios_por_taller[t.id].present? %>
        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background: #f9fafb;">
          <p style="margin: 0 0 8px 0; color: #6b7280; font-size: 14px; font-weight: 500;">
            <%= t.nombre %>
          </p>
          <p style="margin: 0; font-size: 24px; font-weight: 700; color: <%= if @promedios_por_taller[t.id] >= 5.5 then '#16a34a' elsif @promedios_por_taller[t.id] >= 4.0 then '#f59e0b' else '#dc2626' end %>;">
            <%= number_with_precision(@promedios_por_taller[t.id], precision: 1) %>/7.0
          </p>
          <p style="margin: 8px 0 0 0; color: #9ca3af; font-size: 12px;">
            <%= Calificacion.where(taller_id: t.id).count %> estudiante(s) calificado(s)
          </p>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<!-- DATOS -->
<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
  <% if @calificaciones.any? %>
    
    <!-- VERSION DESKTOP (TABLA) -->
    <div style="display: none; overflow-x: auto;" class="desktop-view">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
            <th style="padding: 12px; text-align: left; font-weight: 600;">Estudiante</th>
            <th style="padding: 12px; text-align: left; font-weight: 600;">Taller</th>
            <th style="padding: 12px; text-align: left; font-weight: 600;">Nota</th>
            <th style="padding: 12px; text-align: left; font-weight: 600;">Descripci√≥n</th>
            <th style="padding: 12px; text-align: left; font-weight: 600;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% @calificaciones.each do |c| %>
            <tr style="border-bottom: 1px solid #e5e7eb;">
              <td style="padding: 12px;"><strong><%= c.estudiante.nombre %></strong></td>
              <td style="padding: 12px;"><%= c.taller.nombre %></td>
              <td style="padding: 12px;">
                <span style="<%= if c.nota >= 5.5 then 'color: #16a34a; font-weight: 600;' elsif c.nota >= 4.0 then 'color: #f59e0b; font-weight: 600;' else 'color: #dc2626; font-weight: 600;' end %>">
                  <%= number_with_precision(c.nota, precision: 1) %>/7.0
                </span>
              </td>
              <td style="padding: 12px; max-width: 300px; word-break: break-word;"><%= truncate(c.descripcion, length: 50) %></td>
              <td style="padding: 12px; white-space: nowrap;">
                <%= link_to "üëÅÔ∏è Ver", calificacione_path(c.id), style: "margin-right: 10px; color: #2563eb; text-decoration: none;" %>
                <%= link_to "‚úèÔ∏è Editar", edit_calificacione_path(c.id), style: "margin-right: 10px; color: #f59e0b; text-decoration: none;" %>
                <%= link_to "üóëÔ∏è Eliminar", calificacione_path(c.id), method: :delete,
                      data: { confirm: "¬øSeguro?" }, style: "color: #dc2626; text-decoration: none;" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- VERSION MOBILE (CARDS) -->
    <div style="display: block;">
      <% @calificaciones.each do |c| %>
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
          <div style="margin-bottom: 12px;">
            <h2 style="font-size: 16px; font-weight: 600; color: #1f2937; margin: 0;"><%= c.estudiante.nombre %></h2>
            <p style="font-size: 12px; color: #9ca3af; margin: 4px 0;">Taller: <%= c.taller.nombre %></p>
          </div>
          
          <div style="background: #f9fafb; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="color: #9ca3af; font-weight: 500;">Nota:</span>
              <span style="<%= if c.nota >= 5.5 then 'color: #16a34a; font-weight: 600; font-size: 20px;' elsif c.nota >= 4.0 then 'color: #f59e0b; font-weight: 600; font-size: 20px;' else 'color: #dc2626; font-weight: 600; font-size: 20px;' end %>">
                <%= number_with_precision(c.nota, precision: 1) %>/7.0
              </span>
            </div>
            <% if c.descripcion.present? %>
              <p style="margin: 8px 0; font-size: 14px; color: #4b5563;"><strong>Comentario:</strong> <%= c.descripcion %></p>
            <% end %>
          </div>
          
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <%= link_to "üëÅÔ∏è Ver", calificacione_path(c.id), style: "padding: 8px 12px; background: #2563eb; color: white; border-radius: 4px; text-decoration: none; font-size: 14px; flex-grow: 1; text-align: center;" %>
            <%= link_to "‚úèÔ∏è Editar", edit_calificacione_path(c.id), style: "padding: 8px 12px; background: #f59e0b; color: white; border-radius: 4px; text-decoration: none; font-size: 14px; flex-grow: 1; text-align: center;" %>
            <%= link_to "üóëÔ∏è Eliminar", calificacione_path(c.id), method: :delete,
                  data: { confirm: "¬øSeguro?" }, style: "padding: 8px 12px; background: #dc2626; color: white; border-radius: 4px; text-decoration: none; font-size: 14px; flex-grow: 1; text-align: center;" %>
          </div>
        </div>
      <% end %>
    </div>

    <style>
      @media (min-width: 768px) {
        .desktop-view { display: block !important; }
        div[style*="display: block"]:last-of-type { display: none !important; }
      }
    </style>
  <% else %>
    <p style="text-align: center; color: #6b7280; padding: 20px;">No hay calificaciones registradas. <%= link_to "Crear una", new_calificacione_path, style: "color: #2563eb; text-decoration: underline;" %></p>
  <% end %>
</div>
